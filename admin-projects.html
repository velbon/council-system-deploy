<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS - Project Management</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .admin-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background: white; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 100%; max-width: 4xl; padding: 1.5rem; max-height: 90vh; overflow-y: auto; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #374151; }
        .form-input { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; }
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .form-textarea { resize: vertical; min-height: 120px; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #3b82f6; color: white; } .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #6b7280; color: white; } .btn-secondary:hover { background: #4b5563; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; } .btn-outline:hover { background: #f9fafb; }
        .btn-success { background: #10b981; color: white; } .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; } .btn-danger:hover { background: #dc2626; }
        .btn-warning { background: #f59e0b; color: white; } .btn-warning:hover { background: #d97706; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-green { background: #d1fae5; color: #065f46; }
        .badge-red { background: #fee2e2; color: #991b1b; }
        .badge-blue { background: #dbeafe; color: #1e40af; }
        .badge-yellow { background: #fef3c7; color: #92400e; }
        .badge-purple { background: #e9d5ff; color: #7c3aed; }
        .badge-gray { background: #f3f4f6; color: #374151; }
        .alert-success { background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981; margin: 1rem 0; }
        .alert-error { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #ef4444; margin: 1rem 0; }
        .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #10b981; transition: width 0.3s; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .table th { background: #f9fafb; font-weight: 600; }
        @media (max-width: 768px) {
            .modal-content { margin: 1rem; max-width: calc(100vw - 2rem); }
            .grid-cols-2, .grid-cols-3, .grid-cols-4 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root">
        <div style="text-align: center; padding: 3rem; color: #6b7280;">
            üîÑ Loading Project Management...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const ProjectManagement = () => {
            const [projects, setProjects] = useState([]);
            const [councils, setCouncils] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState("");
            const [showModal, setShowModal] = useState(false);
            const [editingProject, setEditingProject] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [exchangeRate] = useState(0.000051); // SLL to USD

            // Demo councils data
            const DEMO_COUNCILS = [
                { id: 1, name: 'Freetown City Council', district: 'Western Area Urban' },
                { id: 2, name: 'Bo City Council', district: 'Bo District' },
                { id: 3, name: 'Kenema City Council', district: 'Kenema District' },
                { id: 4, name: 'Makeni City Council', district: 'Bombali District' },
                { id: 5, name: 'Koidu New Sembehun City Council', district: 'Kono District' }
            ];

            // Demo projects data
            const DEMO_PROJECTS = [
                {
                    id: 1,
                    title: 'Freetown Roads Improvement Project',
                    description: 'Major infrastructure project to improve road conditions in central Freetown, including resurfacing of key arterial roads and installation of proper drainage systems.',
                    council_id: 1,
                    councils: { name: 'Freetown City Council' },
                    budget: 15000000000, // 15 billion SLL
                    start_date: '2024-01-15',
                    end_date: '2024-12-15',
                    status: 'Active',
                    priority: 'high',
                    completion_percentage: 35,
                    category: 'Infrastructure',
                    project_manager: 'Aminata Kamara',
                    created_at: '2024-01-10T00:00:00Z',
                    last_updated: '2024-01-20T10:30:00Z'
                },
                {
                    id: 2,
                    title: 'Bo Market Renovation',
                    description: 'Complete renovation of Bo Central Market including new vendor stalls, improved sanitation facilities, and better security infrastructure.',
                    council_id: 2,
                    councils: { name: 'Bo City Council' },
                    budget: 8500000000, // 8.5 billion SLL
                    start_date: '2024-02-01',
                    end_date: '2024-08-30',
                    status: 'Active',
                    priority: 'medium',
                    completion_percentage: 60,
                    category: 'Commercial',
                    project_manager: 'Mohamed Bangura',
                    created_at: '2024-01-25T00:00:00Z',
                    last_updated: '2024-01-22T14:15:00Z'
                },
                {
                    id: 3,
                    title: 'Kenema Water Supply Enhancement',
                    description: 'Expansion of water treatment capacity and installation of new distribution pipelines to serve growing population in Kenema.',
                    council_id: 3,
                    councils: { name: 'Kenema City Council' },
                    budget: 12000000000, // 12 billion SLL
                    start_date: '2024-03-01',
                    end_date: '2025-02-28',
                    status: 'Planning',
                    priority: 'high',
                    completion_percentage: 15,
                    category: 'Water & Sanitation',
                    project_manager: 'Fatima Sesay',
                    created_at: '2024-02-15T00:00:00Z',
                    last_updated: '2024-02-20T09:45:00Z'
                },
                {
                    id: 4,
                    title: 'Makeni Solar Street Lighting',
                    description: 'Installation of solar-powered LED street lights across major roads and public spaces in Makeni to improve safety and reduce energy costs.',
                    council_id: 4,
                    councils: { name: 'Makeni City Council' },
                    budget: 4200000000, // 4.2 billion SLL
                    start_date: '2024-01-01',
                    end_date: '2024-06-30',
                    status: 'Completed',
                    priority: 'medium',
                    completion_percentage: 100,
                    category: 'Energy',
                    project_manager: 'Ibrahim Koroma',
                    created_at: '2023-12-01T00:00:00Z',
                    last_updated: '2024-07-01T16:00:00Z'
                },
                {
                    id: 5,
                    title: 'Koidu Waste Management System',
                    description: 'Implementation of comprehensive waste collection and disposal system including purchase of new trucks and establishment of recycling center.',
                    council_id: 5,
                    councils: { name: 'Koidu New Sembehun City Council' },
                    budget: 6800000000, // 6.8 billion SLL
                    start_date: '2024-02-15',
                    end_date: '2024-11-30',
                    status: 'Active',
                    priority: 'high',
                    completion_percentage: 25,
                    category: 'Environmental',
                    project_manager: 'Adama Mansaray',
                    created_at: '2024-02-01T00:00:00Z',
                    last_updated: '2024-02-18T11:20:00Z'
                }
            ];

            // Check authentication
            useEffect(() => {
                const user = JSON.parse(localStorage.getItem('ppms_user') || '{}');
                if (!user.id || (user.role !== 'admin' && user.role !== 'council_user')) {
                    window.location.href = 'login.html';
                    return;
                }
                setCurrentUser(user);
            }, []);

            // Load demo data
            useEffect(() => {
                setProjects(DEMO_PROJECTS);
                setCouncils(DEMO_COUNCILS);
                setLoading(false);
                showMessage('Demo mode - using sample project data');
            }, []);

            const showMessage = (msg, isError = false) => {
                setMessage(isError ? `‚ùå ${msg}` : `‚úÖ ${msg}`);
                setTimeout(() => setMessage(""), 3000);
            };

            const createProject = (projectData) => {
                const selectedCouncil = councils.find(c => c.id === parseInt(projectData.council_id));
                const newProject = {
                    ...projectData,
                    id: projects.length + 1,
                    councils: { name: selectedCouncil?.name || 'Unknown Council' },
                    budget: parseInt(projectData.budget),
                    completion_percentage: 0,
                    created_at: new Date().toISOString(),
                    last_updated: new Date().toISOString()
                };
                setProjects([newProject, ...projects]);
                showMessage("Project created successfully!");
                setShowModal(false);
            };

            const updateProject = (projectData) => {
                const selectedCouncil = councils.find(c => c.id === parseInt(projectData.council_id));
                setProjects(projects.map(project => 
                    project.id === editingProject.id 
                        ? { 
                            ...project, 
                            ...projectData,
                            councils: { name: selectedCouncil?.name || 'Unknown Council' },
                            budget: parseInt(projectData.budget),
                            last_updated: new Date().toISOString()
                          }
                        : project
                ));
                showMessage("Project updated successfully!");
                setShowModal(false);
                setEditingProject(null);
            };

            const formatSLL = (amount) => {
                if (!amount) return 'SLL 0';
                return `SLL ${Number(amount).toLocaleString()}`;
            };

            const formatUSD = (sllAmount) => {
                if (!sllAmount || !exchangeRate) return '$0.00';
                const usdAmount = sllAmount * exchangeRate;
                return `$${usdAmount.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            };

            const getStatusBadgeClass = (status) => {
                switch (status?.toLowerCase()) {
                    case 'active': return 'badge-blue';
                    case 'completed': return 'badge-green';
                    case 'planning': return 'badge-yellow';
                    case 'on-hold': return 'badge-gray';
                    case 'cancelled': return 'badge-red';
                    default: return 'badge-gray';
                }
            };

            const getPriorityBadgeClass = (priority) => {
                switch (priority?.toLowerCase()) {
                    case 'high': return 'badge-red';
                    case 'medium': return 'badge-yellow';
                    case 'low': return 'badge-green';
                    default: return 'badge-gray';
                }
            };

            const getCategoryBadgeClass = (category) => {
                switch (category?.toLowerCase()) {
                    case 'infrastructure': return 'badge-blue';
                    case 'water & sanitation': return 'badge-blue';
                    case 'commercial': return 'badge-purple';
                    case 'energy': return 'badge-yellow';
                    case 'environmental': return 'badge-green';
                    default: return 'badge-gray';
                }
            };

            if (loading) {
                return (
                    <div style={{textAlign: 'center', padding: '3rem', color: '#6b7280'}}>
                        üîÑ Loading Project Management...
                    </div>
                );
            }

            const totalBudget = projects.reduce((sum, p) => sum + p.budget, 0);
            const activeProjects = projects.filter(p => p.status === 'Active').length;
            const avgCompletion = projects.length > 0 ? Math.round(projects.reduce((sum, p) => sum + p.completion_percentage, 0) / projects.length) : 0;

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="admin-header text-white p-6">
                        <div className="max-w-7xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-3xl font-bold">üìä Project Management</h1>
                                <p className="text-blue-100 mt-2">Track and manage public projects</p>
                            </div>
                            <div className="flex items-center space-x-4">
                                <a 
                                    href="admin-enhanced.html" 
                                    className="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg text-white font-medium transition-colors"
                                >
                                    üè† Admin Dashboard
                                </a>
                                <div className="text-sm">
                                    Welcome, {currentUser?.name || 'User'}
                                </div>
                                <button
                                    onClick={() => {
                                        localStorage.removeItem('ppms_user');
                                        window.location.href = 'login.html';
                                    }}
                                    className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-white font-medium transition-colors"
                                >
                                    üö™ Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Message Display */}
                    {message && (
                        <div className="max-w-7xl mx-auto px-6 mt-4">
                            <div className={message.includes('‚ùå') ? 'alert-error' : 'alert-success'}>
                                {message}
                            </div>
                        </div>
                    )}

                    <div className="max-w-7xl mx-auto p-6">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="card">
                                <div className="text-2xl font-bold text-blue-600">{projects.length}</div>
                                <div className="text-gray-600">Total Projects</div>
                            </div>
                            <div className="card">
                                <div className="text-2xl font-bold text-green-600">{activeProjects}</div>
                                <div className="text-gray-600">Active Projects</div>
                            </div>
                            <div className="card">
                                <div className="text-2xl font-bold text-purple-600">
                                    {formatSLL(totalBudget)}
                                </div>
                                <div className="text-gray-600">Total Budget</div>
                                <div className="text-xs text-gray-500">‚âà {formatUSD(totalBudget)}</div>
                            </div>
                            <div className="card">
                                <div className="text-2xl font-bold text-orange-600">{avgCompletion}%</div>
                                <div className="text-gray-600">Avg. Completion</div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-gray-900">Projects Portfolio</h2>
                            <button
                                onClick={() => {
                                    setEditingProject(null);
                                    setShowModal(true);
                                }}
                                className="btn btn-primary"
                            >
                                ‚ûï Create New Project
                            </button>
                        </div>

                        {/* Projects Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            {projects.map(project => (
                                <div key={project.id} className="card">
                                    <div className="flex justify-between items-start mb-3">
                                        <h3 className="text-lg font-semibold text-gray-900">{project.title}</h3>
                                        <span className={`badge ${getStatusBadgeClass(project.status)}`}>
                                            {project.status}
                                        </span>
                                    </div>
                                    
                                    <div className="text-sm text-gray-600 mb-3">
                                        <div className="flex items-center gap-4 mb-2">
                                            <span>üèõÔ∏è {project.councils?.name}</span>
                                            <span className={`badge ${getCategoryBadgeClass(project.category)}`}>
                                                {project.category}
                                            </span>
                                            <span className={`badge ${getPriorityBadgeClass(project.priority)}`}>
                                                {project.priority} priority
                                            </span>
                                        </div>
                                        <div>üìÖ {formatDate(project.start_date)} - {formatDate(project.end_date)}</div>
                                        <div>üë§ {project.project_manager}</div>
                                    </div>
                                    
                                    <p className="text-gray-600 text-sm mb-4 line-clamp-2">
                                        {project.description}
                                    </p>
                                    
                                    <div className="space-y-3">
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span>Progress</span>
                                                <span className="font-medium">{project.completion_percentage}%</span>
                                            </div>
                                            <div className="progress-bar">
                                                <div 
                                                    className="progress-fill"
                                                    style={{width: `${project.completion_percentage}%`}}
                                                ></div>
                                            </div>
                                        </div>
                                        
                                        <div className="text-sm">
                                            <div className="font-medium">{formatSLL(project.budget)}</div>
                                            <div className="text-gray-500">‚âà {formatUSD(project.budget)}</div>
                                        </div>
                                    </div>
                                    
                                    <div className="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                                        <button
                                            onClick={() => {
                                                setEditingProject(project);
                                                setShowModal(true);
                                            }}
                                            className="btn btn-sm btn-outline"
                                        >
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button
                                            onClick={() => showMessage("Project details view not implemented in demo")}
                                            className="btn btn-sm btn-secondary"
                                        >
                                            üëÅÔ∏è View Details
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Modal */}
                    {showModal && <ProjectModal />}
                </div>
            );

            // Modal Component
            function ProjectModal() {
                const [formData, setFormData] = useState(
                    editingProject || {
                        title: '',
                        description: '',
                        council_id: '',
                        budget: '',
                        start_date: '',
                        end_date: '',
                        status: 'Planning',
                        priority: 'medium',
                        category: 'Infrastructure',
                        project_manager: '',
                        completion_percentage: 0
                    }
                );

                const categories = [
                    'Infrastructure',
                    'Water & Sanitation',
                    'Commercial',
                    'Energy',
                    'Environmental',
                    'Education',
                    'Healthcare',
                    'Transportation'
                ];

                const statuses = [
                    'Planning',
                    'Active',
                    'On-Hold',
                    'Completed',
                    'Cancelled'
                ];

                const priorities = [
                    'low',
                    'medium',
                    'high'
                ];

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (editingProject) {
                        updateProject(formData);
                    } else {
                        createProject(formData);
                    }
                };

                return (
                    <div className="modal-overlay">
                        <div className="modal-content">
                            <h3 className="text-lg font-semibold mb-4">
                                {editingProject ? 'Edit Project' : 'Create New Project'}
                            </h3>
                            
                            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="md:col-span-2 form-group">
                                    <label className="form-label">Project Title *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.title}
                                        onChange={(e) => setFormData({...formData, title: e.target.value})}
                                        required
                                    />
                                </div>

                                <div className="md:col-span-2 form-group">
                                    <label className="form-label">Description *</label>
                                    <textarea
                                        className="form-input form-textarea"
                                        value={formData.description}
                                        onChange={(e) => setFormData({...formData, description: e.target.value})}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Council *</label>
                                    <select
                                        className="form-input"
                                        value={formData.council_id}
                                        onChange={(e) => setFormData({...formData, council_id: e.target.value})}
                                        required
                                    >
                                        <option value="">Select Council</option>
                                        {councils.map(council => (
                                            <option key={council.id} value={council.id}>
                                                {council.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Budget (SLL) *</label>
                                    <input
                                        type="number"
                                        className="form-input"
                                        value={formData.budget}
                                        onChange={(e) => setFormData({...formData, budget: e.target.value})}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Start Date *</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.start_date}
                                        onChange={(e) => setFormData({...formData, start_date: e.target.value})}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">End Date *</label>
                                    <input
                                        type="date"
                                        className="form-input"
                                        value={formData.end_date}
                                        onChange={(e) => setFormData({...formData, end_date: e.target.value})}
                                        required
                                    />
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Category *</label>
                                    <select
                                        className="form-input"
                                        value={formData.category}
                                        onChange={(e) => setFormData({...formData, category: e.target.value})}
                                        required
                                    >
                                        {categories.map(category => (
                                            <option key={category} value={category}>{category}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Status *</label>
                                    <select
                                        className="form-input"
                                        value={formData.status}
                                        onChange={(e) => setFormData({...formData, status: e.target.value})}
                                        required
                                    >
                                        {statuses.map(status => (
                                            <option key={status} value={status}>{status}</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Priority *</label>
                                    <select
                                        className="form-input"
                                        value={formData.priority}
                                        onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                        required
                                    >
                                        {priorities.map(priority => (
                                            <option key={priority} value={priority}>
                                                {priority.charAt(0).toUpperCase() + priority.slice(1)}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">Project Manager *</label>
                                    <input
                                        type="text"
                                        className="form-input"
                                        value={formData.project_manager}
                                        onChange={(e) => setFormData({...formData, project_manager: e.target.value})}
                                        required
                                    />
                                </div>

                                {editingProject && (
                                    <div className="form-group">
                                        <label className="form-label">Completion Percentage</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={formData.completion_percentage}
                                            onChange={(e) => setFormData({...formData, completion_percentage: parseInt(e.target.value)})}
                                            min="0"
                                            max="100"
                                        />
                                    </div>
                                )}

                                <div className="md:col-span-2 flex justify-end gap-3 mt-6">
                                    <button
                                        type="button"
                                        onClick={() => {
                                            setShowModal(false);
                                            setEditingProject(null);
                                        }}
                                        className="btn btn-outline"
                                    >
                                        Cancel
                                    </button>
                                    <button type="submit" className="btn btn-primary">
                                        {editingProject ? 'Update' : 'Create'} Project
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                );
            }
        };

        // Render the app
        ReactDOM.render(<ProjectManagement />, document.getElementById('root'));
    </script>
</body>
</html>
