<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPMS — Live Supabase Data</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; }
        .loading { text-align: center; padding: 3rem; color: #6b7280; }
        .error-message { background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #dc2626; margin: 1rem 0; }
        .success-message { background: #d1fae5; color: #065f46; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #10b981; margin: 1rem 0; }
        .btn { padding: 0.5rem 1rem; margin: 0.25rem; border-radius: 0.375rem; border: 1px solid transparent; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #3b82f6; color: white; } .btn-primary:hover { background: #2563eb; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; } .btn-outline:hover { background: #f9fafb; }
        .council-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
        .council-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .stats-card { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 p-6">
    <div id="root">
        <div class="loading">🔄 Starting PPMS...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [councils, setCouncils] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState("");

            useEffect(() => {
                const initApp = async () => {
                    try {
                        console.log('Initializing Supabase...');
                        
                        const supabaseUrl = 'https://lschntjazpnyljuauyuy.supabase.co';
                        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxzY2hudGphenBueWxqdWF1eXV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3ODQzMzAsImV4cCI6MjA3MDM2MDMzMH0.CvnMldHeMxohRrnlrC6V_AvJMYw8HiFv5HRHnFvq05E';
                        
                        if (typeof supabase === 'undefined') {
                            throw new Error('Supabase not loaded');
                        }
                        
                        const client = supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('Supabase client created');
                        
                        // Test with the simplest possible query
                        console.log('Testing connection...');
                        const { data: testData, error: testError } = await client
                            .from('councils')
                            .select('id')
                            .limit(1);
                        
                        if (testError) {
                            throw new Error(`Connection failed: ${testError.message}`);
                        }
                        
                        console.log('Connection successful, fetching data...');
                        
                        // Fetch councils
                        const { data: councilData, error: councilError } = await client
                            .from('councils')
                            .select('id, name, location');
                        
                        if (councilError) {
                            throw new Error(`Councils fetch failed: ${councilError.message}`);
                        }
                        
                        console.log('Councils fetched:', councilData?.length);
                        
                        // Fetch projects for each council
                        const councilsWithProjects = [];
                        for (const council of councilData || []) {
                            const { data: projects, error: projError } = await client
                                .from('projects')
                                .select('id, title, status, budget')
                                .eq('council_id', council.id);
                            
                            councilsWithProjects.push({
                                ...council,
                                projects: projects || []
                            });
                        }
                        
                        setCouncils(councilsWithProjects);
                        setMessage(`✅ Loaded ${councilsWithProjects.length} councils successfully`);
                        setTimeout(() => setMessage(''), 3000);
                        
                    } catch (error) {
                        console.error('App init error:', error);
                        setMessage(`❌ Error: ${error.message}`);
                    } finally {
                        setLoading(false);
                    }
                };
                
                initApp();
            }, []);

            const totalProjects = councils.reduce((sum, c) => sum + c.projects.length, 0);

            if (loading) {
                return (
                    <div className="max-w-4xl mx-auto">
                        <div className="loading">
                            🔄 Loading PPMS Dashboard...
                        </div>
                    </div>
                );
            }

            return (
                <div className="max-w-7xl mx-auto space-y-6">
                    {/* Header */}
                    <header>
                        <h1 className="text-3xl font-bold text-gray-900">PPMS Dashboard</h1>
                        <p className="text-gray-600">Live Supabase Data • {councils.length} councils • {totalProjects} projects</p>
                    </header>

                    {/* Message */}
                    {message && (
                        <div className={message.includes('❌') ? 'error-message' : 'success-message'}>
                            {message}
                        </div>
                    )}

                    {/* Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="stats-card">
                            <div className="text-2xl font-bold text-blue-600">{councils.length}</div>
                            <div className="text-sm text-gray-600">Total Councils</div>
                        </div>
                        <div className="stats-card">
                            <div className="text-2xl font-bold text-green-600">{totalProjects}</div>
                            <div className="text-sm text-gray-600">Total Projects</div>
                        </div>
                        <div className="stats-card">
                            <div className="text-2xl font-bold text-purple-600">
                                {councils.reduce((sum, c) => sum + c.projects.filter(p => p.status === 'Active').length, 0)}
                            </div>
                            <div className="text-sm text-gray-600">Active Projects</div>
                        </div>
                    </div>

                    {/* Councils */}
                    <section>
                        <h2 className="text-xl font-semibold mb-4">Councils</h2>
                        <div className="council-grid">
                            {councils.map(council => (
                                <div key={council.id} className="council-card">
                                    <h3 className="font-bold text-lg mb-2">{council.name}</h3>
                                    <p className="text-gray-600 text-sm mb-3">{council.location}</p>
                                    <p className="text-sm text-gray-500 mb-4">
                                        {council.projects.length} projects
                                    </p>
                                    
                                    {council.projects.length > 0 && (
                                        <div className="space-y-2">
                                            <h4 className="font-semibold text-sm">Projects:</h4>
                                            {council.projects.slice(0, 3).map(project => (
                                                <div key={project.id} className="text-sm p-2 bg-gray-50 rounded">
                                                    <div className="font-medium">{project.title}</div>
                                                    <div className="flex justify-between items-center mt-1">
                                                        <span className="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800">
                                                            {project.status}
                                                        </span>
                                                        {project.budget && (
                                                            <span className="text-xs text-gray-600">
                                                                ${project.budget.toLocaleString()}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                            {council.projects.length > 3 && (
                                                <div className="text-xs text-gray-500">
                                                    +{council.projects.length - 3} more projects
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        {councils.length === 0 && (
                            <div className="text-center py-8 text-gray-500">
                                <p>No councils loaded yet.</p>
                                <button 
                                    className="btn btn-primary mt-4"
                                    onClick={() => window.location.reload()}
                                >
                                    🔄 Retry
                                </button>
                            </div>
                        )}
                    </section>

                    {/* Footer */}
                    <footer className="text-center text-sm text-gray-400 pt-8">
                        PPMS Dashboard • {new Date().toLocaleDateString()}
                    </footer>
                </div>
            );
        };

        // Render
        try {
            ReactDOM.render(<App />, document.getElementById('root'));
        } catch (error) {
            console.error('Render error:', error);
            document.getElementById('root').innerHTML = `
                <div style="padding: 2rem; background: #fee2e2; color: #991b1b; border-radius: 0.5rem; margin: 2rem;">
                    <h2>❌ Render Error</h2>
                    <p>${error.message}</p>
                    <button onclick="window.location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #dc2626; color: white; border: none; border-radius: 0.25rem;">
                        Reload
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>
